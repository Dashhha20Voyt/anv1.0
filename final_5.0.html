<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aging Theory Analyzer Enterprise</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg: #f1f5f9;
            --surface: #ffffff;
            --text: #0f172a;
            --border: #e2e8f0;
            --nav-bg: #1e293b;
            --nav-active: #38bdf8;
        }

        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }

        /* Navbar */
        .navbar { background: var(--nav-bg); color: white; height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; flex-shrink: 0; }
        .nav-tabs { display: flex; height: 100%; gap: 10px; }
        .nav-tab { padding: 0 15px; height: 100%; display: flex; align-items: center; cursor: pointer; opacity: 0.7; border-bottom: 3px solid transparent; font-size: 0.9rem; transition: 0.2s; }
        .nav-tab:hover { opacity: 1; background: rgba(255,255,255,0.05); }
        .nav-tab.active { opacity: 1; border-bottom-color: var(--nav-active); color: var(--nav-active); }
        .nav-tab i { margin-right: 8px; }

        /* Layout */
        .main-content { flex-grow: 1; padding: 20px; overflow: hidden; display: flex; }
        .tab-pane { display: none; width: 100%; height: 100%; flex-direction: column; }
        .tab-pane.active { display: flex; }

        .dashboard-grid { display: grid; grid-template-columns: 350px 1fr; gap: 20px; height: 100%; }
        .panel { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; }
        .panel-header { padding: 12px 15px; background: #f8fafc; border-bottom: 1px solid var(--border); font-weight: 600; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
        .panel-body { padding: 15px; overflow-y: auto; flex-grow: 1; }

        /* Forms */
        .form-group { margin-bottom: 12px; }
        label { display: block; font-size: 0.8rem; font-weight: 600; color: #64748b; margin-bottom: 4px; }
        input, select { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 0.9rem; }

        /* Buttons */
        .btn { padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; width: 100%; justify-content: center; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text); }
        .btn-secondary:hover { background: #f8fafc; }

        /* Tags */
        .tag-container { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
        .tag { background: #eff6ff; border: 1px solid #bfdbfe; color: var(--primary); padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; display: flex; align-items: center; gap: 5px; }
        .tag i { cursor: pointer; color: #ef4444; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 8px; border: 1px solid var(--border); text-align: center; }
        .stat-val { font-size: 1.8rem; font-weight: 700; color: var(--text); }
        .stat-lbl { font-size: 0.8rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Table */
        .table-wrapper { flex-grow: 1; overflow: auto; border: 1px solid var(--border); background: white; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { position: sticky; top: 0; background: #f1f5f9; text-align: left; padding: 10px; font-size: 0.8rem; color: #64748b; z-index: 10; }
        td { padding: 10px; border-bottom: 1px solid var(--border); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9rem; }
        tr:hover { background: #f8fafc; }

        /* Code Block */
        pre { margin: 0; padding: 15px; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: #334155; overflow: auto; height: 100%; }
    </style>
</head>
<body>
    <div class="navbar">
        <div style="font-weight: 600; display:flex; align-items:center; gap:10px;">
            <i class="fas fa-dna" style="color:var(--nav-active)"></i> Aging Theory Analyzer
        </div>
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="openTab('dashboard')"><i class="fas fa-sliders-h"></i> Dashboard</div>
            <div class="nav-tab" onclick="openTab('stats')"><i class="fas fa-chart-bar"></i> Statistics</div>
            <div class="nav-tab" onclick="openTab('logs')"><i class="fas fa-terminal"></i> Logs</div>
            <div class="nav-tab" onclick="openTab('data')"><i class="fas fa-table"></i> Data</div>
            <div class="nav-tab" onclick="openTab('code')"><i class="fas fa-code"></i> Backend</div>
        </div>
        <div style="display:flex; gap:5px">
            <button class="btn btn-secondary" style="font-size:0.8rem; padding:5px 10px;" onclick="exportData('csv')">CSV</button>
            <button class="btn btn-secondary" style="font-size:0.8rem; padding:5px 10px;" onclick="exportData('json')">JSON</button>
        </div>
    </div>

    <div class="main-content">
        <!-- Dashboard -->
        <div id="dashboard" class="tab-pane active">
            <div class="dashboard-grid">
                <div class="panel">
                    <div class="panel-header">Settings</div>
                    <div class="panel-body">
                        <div class="form-group">
                            <label>LLM Provider</label>
                            <select id="llmProvider">
                                <option value="groq">Groq (Fastest/Free)</option>
                                <option value="openai">OpenAI (GPT-4)</option>
                                <option value="anthropic">Anthropic (Claude 3.5)</option>
                                <option value="mistral">Mistral AI</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Model Name</label>
                            <input type="text" id="modelName" value="llama3-70b-8192" placeholder="e.g. gpt-4-turbo">
                        </div>
                        <div class="form-group">
                            <label>API Key</label>
                            <input type="password" id="apiKey" placeholder="sk-...">
                        </div>
                        <div class="form-group">
                            <label>Backend URL</label>
                            <input type="text" id="backendUrl" value="http://localhost:8000">
                        </div>
                        <div class="form-group" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                            <div><label>From</label><input type="number" id="yearFrom" value="2000"></div>
                            <div><label>To</label><input type="number" id="yearTo" value="2025"></div>
                        </div>
                        <div class="form-group">
                            <label>Max Papers</label>
                            <input type="number" id="maxPapers" value="1000">
                        </div>
                        <button class="btn btn-primary" id="startBtn" onclick="startAnalysis()">
                            <i class="fas fa-play"></i> Start Analysis
                        </button>
                        <div id="status" style="margin-top:10px; font-size:0.8rem; color:#64748b; text-align:center;">Ready</div>
                        <div style="background:#e2e8f0; height:4px; margin-top:5px; border-radius:2px; overflow:hidden;">
                            <div id="progress" style="width:0%; height:100%; background:var(--primary); transition:0.3s;"></div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        Research Queries
                        <button class="btn btn-secondary" style="padding:2px 8px; font-size:0.7rem;" onclick="clearQueries()">Clear All</button>
                    </div>
                    <div class="panel-body">
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <select id="predefinedQueries" style="flex:1;">
                                <option value="">-- Select Topic --</option>
                                <optgroup label=" Biology - Hallmarks">
                                    <option value="Genomic Instability Aging">Genomic Instability</option>
                                    <option value="Telomere Attrition">Telomere Attrition</option>
                                    <option value="Epigenetic Alterations Aging">Epigenetic Alterations</option>
                                    <option value="Loss of Proteostasis">Loss of Proteostasis</option>
                                    <option value="Mitochondrial Dysfunction">Mitochondrial Dysfunction</option>
                                    <option value="Cellular Senescence">Cellular Senescence</option>
                                    <option value="Stem Cell Exhaustion">Stem Cell Exhaustion</option>
                                    <option value="Altered Intercellular Communication">Altered Intercellular Communication</option>
                                </optgroup>
                                <optgroup label=" Biology - Mechanisms">
                                    <option value="mTOR pathway aging">mTOR Pathway</option>
                                    <option value="AMPK signaling aging">AMPK Signaling</option>
                                    <option value="Sirtuins and longevity">Sirtuins</option>
                                    <option value="NAD+ metabolism aging">NAD+ Metabolism</option>
                                    <option value="Autophagy decline aging">Autophagy Decline</option>
                                    <option value="Inflammaging">Inflammaging</option>
                                    <option value="Microbiome and aging">Gut Microbiome</option>
                                </optgroup>
                                <optgroup label=" Psychology & Cognitive">
                                    <option value="Socioemotional Selectivity Theory">Socioemotional Selectivity</option>
                                    <option value="Cognitive Reserve Theory">Cognitive Reserve</option>
                                    <option value="Gerotranscendence">Gerotranscendence</option>
                                    <option value="Selective Optimization with Compensation">Selective Optimization</option>
                                    <option value="Disengagement Theory">Disengagement Theory</option>
                                    <option value="Activity Theory of Aging">Activity Theory</option>
                                    <option value="Continuity Theory">Continuity Theory</option>
                                </optgroup>
                                <optgroup label=" Physics & Math">
                                    <option value="Gompertz-Makeham law">Gompertz-Makeham Law</option>
                                    <option value="Entropy and aging thermodynamics">Entropy & Thermodynamics</option>
                                    <option value="Reliability theory of aging">Reliability Theory</option>
                                    <option value="Network theory of aging">Network Theory</option>
                                    <option value="Chaos theory in biology">Chaos Theory in Biology</option>
                                </optgroup>
                                <optgroup label="AI & Longevity">
                                    <option value="Deep learning for aging clocks">AI Aging Clocks</option>
                                    <option value="Generative AI drug discovery aging">AI Drug Discovery</option>
                                    <option value="Digital Twins for aging">Digital Twins</option>
                                </optgroup>
                            </select>
                            <button class="btn btn-secondary" onclick="addQuery()">Add</button>
                        </div>
                        <div class="tag-container" id="queryTags"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div id="stats" class="tab-pane">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-val" id="sTotal">0</div><div class="stat-lbl">Total Papers</div></div>
                <div class="stat-card"><div class="stat-val" id="sProcessed">0</div><div class="stat-lbl">Processed</div></div>
                <div class="stat-card"><div class="stat-val" id="sRelevant" style="color:#10b981">0</div><div class="stat-lbl">Theories Found</div></div>
                <div class="stat-card"><div class="stat-val" id="sErrors" style="color:#ef4444">0</div><div class="stat-lbl">Errors</div></div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; height:400px;">
                <div class="panel"><div class="panel-header">Relevance</div><div class="panel-body"><canvas id="cPie"></canvas></div></div>
                <div class="panel"><div class="panel-header">Timeline</div><div class="panel-body"><canvas id="cBar"></canvas></div></div>
            </div>
        </div>

        <!-- Logs -->
        <div id="logs" class="tab-pane">
            <div class="panel" style="height:100%; background:#0f172a; color:#38bdf8; font-family:monospace; padding:15px; overflow:auto;" id="logBox">
                <div>> System initialized. Ready.</div>
            </div>
        </div>

        <!-- Data -->
        <div id="data" class="tab-pane">
            <div class="table-wrapper" id="tableWrap">
                <table>
                    <thead>
                        <tr><th style="width:50px">#</th><th style="width:80px">Year</th><th>Title</th><th>Theory</th><th>Mechanism</th><th>Relevant</th></tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
                <div id="spacer" style="height:0px"></div>
            </div>
        </div>

        <!-- Code -->
        <div id="code" class="tab-pane">
            <div class="panel" style="height:100%;">
                <div class="panel-header">Current Backend Implementation</div>
                <pre id="backendCodePreview">Loading code...</pre>
            </div>
        </div>
    </div>

    <script>
        // State
        const state = { queries: new Set(['Hallmarks of Aging']), papers: [], results: [], processing: false };
        const charts = {};

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            renderTags();
            initCharts();
            fetchBackendCode();
            document.getElementById('tableWrap').addEventListener('scroll', renderTable);
        });

        function openTab(id) {
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
            if(id === 'data') renderTable();
        }

        // Queries
        function addQuery() {
            const v = document.getElementById('predefinedQueries').value;
            if(v) state.queries.add(v);
            renderTags();
        }
        function removeQuery(q) { state.queries.delete(q); renderTags(); }
        function clearQueries() { state.queries.clear(); renderTags(); }
        function renderTags() {
            const c = document.getElementById('queryTags');
            c.innerHTML = '';
            state.queries.forEach(q => {
                c.innerHTML += `<div class="tag">${q} <i class="fas fa-times" onclick="removeQuery('${q}')"></i></div>`;
            });
        }

        // Pipeline
        async function startAnalysis() {
            if(state.queries.size === 0) return alert('Add queries');
            const key = document.getElementById('apiKey').value;
            if(!key) return alert('API Key needed');

            state.processing = true;
            state.results = [];
            updateUI(true);
            log('Starting pipeline...');

            try {
                const url = document.getElementById('backendUrl').value;

                // 1. Collect
                log('Fetching papers from Semantic Scholar...');
                const res1 = await fetch(`${url}/api/collect`, {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({
                        queries: Array.from(state.queries),
                        year_from: document.getElementById('yearFrom').value,
                        year_to: document.getElementById('yearTo').value,
                        max_papers: document.getElementById('maxPapers').value
                    })
                });
                const d1 = await res1.json();
                state.papers = d1.papers;
                log(`Collected ${d1.papers.length} unique papers.`);
                updateStats();

                // 2. Extract Batches
                const total = state.papers.length;
                const batchSize = 10;
                const batches = Math.ceil(total / batchSize);
                const provider = document.getElementById('llmProvider').value;
                const model = document.getElementById('modelName').value;

                for(let i=0; i<batches; i++) {
                    const batch = state.papers.slice(i*batchSize, (i+1)*batchSize);
                    log(`Processing batch ${i+1}/${batches}...`);

                    const res2 = await fetch(`${url}/api/extract/batch`, {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({
                            papers: batch,
                            llm_provider: provider,
                            model_name: model,
                            llm_api_key: key,
                            batch_number: i+1,
                            total_batches: batches
                        })
                    });
                    const d2 = await res2.json();
                    if(d2.results) {
                        state.results.push(...d2.results);
                        updateStats();
                        renderTable();
                    }

                    document.getElementById('progress').style.width = `${((i+1)/batches)*100}%`;
                }
                log('Analysis Complete!');

            } catch(e) {
                log(`Error: ${e.message}`);
            }
            state.processing = false;
            updateUI(false);
        }

        // Helpers
        function log(m) { 
            const b = document.getElementById('logBox');
            b.innerHTML += `<div>> [${new Date().toLocaleTimeString()}] ${m}</div>`;
            b.scrollTop = b.scrollHeight;
        }
        function updateUI(busy) {
            document.getElementById('startBtn').disabled = busy;
            document.getElementById('status').innerText = busy ? 'Running...' : 'Idle';
        }
        function updateStats() {
            document.getElementById('sTotal').innerText = state.papers.length;
            document.getElementById('sProcessed').innerText = state.results.length;
            const rel = state.results.filter(r => r.q2 === 'Yes').length;
            document.getElementById('sRelevant').innerText = rel;

            // Charts
            charts.pie.data.datasets[0].data = [rel, state.results.length - rel];
            charts.pie.update();

            const years = {};
            state.results.filter(r => r.q2 === 'Yes').forEach(r => years[r.year] = (years[r.year]||0)+1);
            charts.bar.data.labels = Object.keys(years).sort();
            charts.bar.data.datasets[0].data = Object.keys(years).sort().map(k => years[k]);
            charts.bar.update();
        }

        // Virtual Table
        function renderTable() {
            const wrap = document.getElementById('tableWrap');
            const tbody = document.getElementById('tableBody');
            const h = 45; // row height
            const total = state.results.length;
            document.getElementById('spacer').style.height = `${total*h}px`;

            const start = Math.floor(wrap.scrollTop / h);
            const end = Math.min(total, start + 30); // + buffer

            let html = `<tr style="height:${start*h}px"><td colspan="6" style="border:none"></td></tr>`;
            for(let i=start; i<end; i++) {
                const r = state.results[i];
                const color = r.q2 === 'Yes' ? '#dcfce7' : '#f1f5f9';
                html += `<tr style="height:${h}px; background:${color}">
                    <td>${i+1}</td><td>${r.year||''}</td>
                    <td title="${r.title}">${(r.title||'').substring(0,50)}...</td>
                    <td>${(r.q3_theory_name||'').substring(0,30)}</td>
                    <td>${(r.q5_mechanism||'').substring(0,30)}</td>
                    <td>${r.q2}</td></tr>`;
            }
            tbody.innerHTML = html;
        }

        // Charts
        function initCharts() {
            charts.pie = new Chart(document.getElementById('cPie'), {
                type: 'doughnut', data: { labels:['Yes','No'], datasets:[{data:[0,0], backgroundColor:['#10b981','#cbd5e1']}] },
                options: { maintainAspectRatio:false }
            });
            charts.bar = new Chart(document.getElementById('cBar'), {
                type: 'bar', data: { labels:[], datasets:[{label:'Papers', data:[], backgroundColor:'#3b82f6'}] },
                options: { maintainAspectRatio:false }
            });
        }

        // Export
        function exportData(fmt) {
            if(!state.results.length) return alert('No data');
            let blob;
            if(fmt === 'json') {
                blob = new Blob([JSON.stringify(state.results,null,2)], {type:'application/json'});
            } else {
                let csv = 'id,year,title,theory,mechanism,full_text\n';
                state.results.forEach(r => {
                    csv += `"${r.paper_id}","${r.year}","${(r.title||'').replace(/"/g,'""')}","${(r.q3_theory_name||'').replace(/"/g,'""')}","${(r.q5_mechanism||'').replace(/"/g,'""')}","${(r.abstract||'').replace(/"/g,'""')}"\n`;
                });
                blob = new Blob([csv], {type:'text/csv'});
            }
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href=url; a.download = `export.${fmt}`; a.click();
        }

        async function fetchBackendCode() {
             try {
                const res = await fetch('/api/code');
                const text = await res.text();
                document.getElementById('backendCodePreview').innerText = text;
             } catch(e) { document.getElementById('backendCodePreview').innerText = "Could not load code."; }
        }
    </script>
</body>
</html>
